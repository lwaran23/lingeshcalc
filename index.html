<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scientific Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
    <style>
        body {
            font-family: "Inter", "Space Grotesk", "Noto Sans", sans-serif;
            min-height: 100dvh; /* Use dvh for dynamic viewport height */
            background-color: #0f172a; /* bg-slate-900 */
        }
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 0.5rem; /* Reduced gap for rounder buttons md:gap-3 */
        }
        .calculator-button { /* Base class for all buttons for easier selection if needed */
            transform-origin: center; /* Ensures scaling is centered */
        }

        /* Custom message box for errors/alerts */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .message-box-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .message-box-content {
            background-color: #1e293b; /* bg-slate-800 */
            color: white;
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); /* shadow-lg */
            text-align: center;
            max-width: 90%;
            width: 300px;
        }
        .message-box-content p {
            margin-bottom: 1rem;
        }
        .message-box-content button {
            background-color: #4f46e5; /* bg-indigo-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .message-box-content button:hover {
            background-color: #4338ca; /* hover:bg-indigo-700 */
        }
    </style>
</head>
<body class="flex justify-center items-center p-2 md:p-4">
    <div class="w-full max-w-md bg-slate-800 rounded-2xl shadow-2xl p-4 md:p-6">
        <div class="mb-4 md:mb-6">
            <input id="display" class="form-input flex w-full resize-none overflow-hidden rounded-lg text-right text-5xl md:text-6xl font-bold text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 border-none bg-slate-900 h-24 md:h-28 placeholder:text-slate-500 p-4" readonly value="0"/>
        </div>
        <div class="calculator-grid">
            <button data-value="(" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-700 text-slate-300 hover:bg-slate-600 hover:scale-105 active:scale-95">(</button>
            <button data-value=")" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-700 text-slate-300 hover:bg-slate-600 hover:scale-105 active:scale-95">)</button>
            <button data-value="mc" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-base md:text-lg font-medium transition-all duration-150 ease-in-out bg-slate-600 text-slate-200 hover:bg-slate-500 hover:scale-105 active:scale-95">mc</button>
            <button data-value="m+" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-base md:text-lg font-medium transition-all duration-150 ease-in-out bg-slate-600 text-slate-200 hover:bg-slate-500 hover:scale-105 active:scale-95">m+</button>
            <button data-value="m-" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-base md:text-lg font-medium transition-all duration-150 ease-in-out bg-slate-600 text-slate-200 hover:bg-slate-500 hover:scale-105 active:scale-95">m-</button>
            <button id="secondFnButton" data-value="2nd" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-sm md:text-base font-medium transition-all duration-150 ease-in-out bg-slate-700 text-slate-300 hover:bg-slate-600 hover:scale-105 active:scale-95">2<sup>nd</sup></button>
            <button data-value="x^2" data-second-value="x^3" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">x²</button>
            <button data-value="x^3" data-second-value="x^y" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">x³</button>
            <button data-value="x^y" data-second-value="y_sqrt_x" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">xʸ</button>
            <button data-value="e^x" data-second-value="10^x" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">eˣ</button>
            <button data-value="10^x" data-second-value="1/x" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">10ˣ</button>
            <button data-value="1/x" data-second-value="sqrt" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">¹/x</button>
            <button data-value="sqrt" data-second-value="cbrt" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">√x</button>
            <button data-value="cbrt" data-second-value="y_sqrt_x" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">∛x</button>
            <button data-value="ln" data-second-value="log10" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">ln</button>
            <button data-value="log10" data-second-value="log2" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-base md:text-lg font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">log₁₀</button>
            <button data-value="x!" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">x!</button>
            <button data-value="sin" data-second-value="asin" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-base md:text-lg font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">sin</button>
            <button data-value="cos" data-second-value="acos" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-base md:text-lg font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">cos</button>
            <button data-value="tan" data-second-value="atan" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-base md:text-lg font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">tan</button>
            <button data-value="E" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-700 text-slate-300 hover:bg-slate-600 hover:scale-105 active:scale-95">e</button>
            <button data-value="EE" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-base md:text-lg font-medium transition-all duration-150 ease-in-out bg-slate-700 text-slate-300 hover:bg-slate-600 hover:scale-105 active:scale-95">EE</button>
            <button id="radDegButton" data-value="Rad" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-base md:text-lg font-medium transition-all duration-150 ease-in-out bg-slate-700 text-slate-300 hover:bg-slate-600 hover:scale-105 active:scale-95">Rad</button>
            <button data-value="sinh" data-second-value="asinh" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-sm md:text-base font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">sinh</button>
            <button data-value="cosh" data-second-value="acosh" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-sm md:text-base font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">cosh</button>
            <button data-value="tanh" data-second-value="atanh" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-sm md:text-base font-medium transition-all duration-150 ease-in-out bg-purple-600 text-white hover:bg-purple-700 hover:scale-105 active:scale-95">tanh</button>
            <button data-value="PI" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-700 text-slate-300 hover:bg-slate-600 hover:scale-105 active:scale-95">π</button>
            <button id="decimalModeButton" data-value="DecimalMode" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-sm md:text-xs font-medium transition-all duration-150 ease-in-out bg-slate-700 text-slate-300 hover:bg-slate-600 hover:scale-105 active:scale-95 p-1">F</button> <button data-value="/" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-indigo-600 text-white hover:bg-indigo-700 hover:scale-105 active:scale-95">/</button>
            <button data-value="C" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-rose-600 text-white hover:bg-rose-700 hover:scale-105 active:scale-95">C</button>
            <button data-value="7" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-500 text-white hover:bg-slate-400 hover:scale-105 active:scale-95">7</button>
            <button data-value="8" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-500 text-white hover:bg-slate-400 hover:scale-105 active:scale-95">8</button>
            <button data-value="9" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-500 text-white hover:bg-slate-400 hover:scale-105 active:scale-95">9</button>
            <button data-value="*" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-indigo-600 text-white hover:bg-indigo-700 hover:scale-105 active:scale-95">*</button>
            <button data-value="Backspace" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-700 text-slate-300 hover:bg-slate-600 hover:scale-105 active:scale-95">
                <span class="material-icons-outlined text-xl md:text-2xl">backspace</span>
            </button>
            <button data-value="4" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-500 text-white hover:bg-slate-400 hover:scale-105 active:scale-95">4</button>
            <button data-value="5" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-500 text-white hover:bg-slate-400 hover:scale-105 active:scale-95">5</button>
            <button data-value="6" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-500 text-white hover:bg-slate-400 hover:scale-105 active:scale-95">6</button>
            <button data-value="-" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-indigo-600 text-white hover:bg-indigo-700 hover:scale-105 active:scale-95">-</button>
            <button data-value="ToggleSign" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-700 text-slate-300 hover:bg-slate-600 hover:scale-105 active:scale-95">±</button>
            <button data-value="1" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-500 text-white hover:bg-slate-400 hover:scale-105 active:scale-95">1</button>
            <button data-value="2" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-500 text-white hover:bg-slate-400 hover:scale-105 active:scale-95">2</button>
            <button data-value="3" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-500 text-white hover:bg-slate-400 hover:scale-105 active:scale-95">3</button>
            <button data-value="+" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-indigo-600 text-white hover:bg-indigo-700 hover:scale-105 active:scale-95">+</button>
            <button data-value="%" class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-700 text-slate-300 hover:bg-slate-600 hover:scale-105 active:scale-95">%</button>
            <button data-value="0" class="calculator-button flex items-center justify-center rounded-full h-12 md:h-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-500 text-white hover:bg-slate-400 hover:scale-105 active:scale-95 col-span-2">0</button>
            <button data-value="." class="calculator-button flex items-center justify-center rounded-full h-12 w-12 md:h-16 md:w-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-slate-500 text-white hover:bg-slate-400 hover:scale-105 active:scale-95">.</button>
            <button data-value="=" class="calculator-button flex items-center justify-center rounded-full h-12 md:h-16 text-lg md:text-xl font-medium transition-all duration-150 ease-in-out bg-green-500 text-white hover:bg-green-600 hover:scale-105 active:scale-95 col-span-2">=</button>
        </div>
    </div>

    <div id="messageBoxOverlay" class="message-box-overlay">
        <div class="message-box-content">
            <p id="messageBoxText"></p>
            <button id="messageBoxOkButton">OK</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const display = document.getElementById('display');
            const buttons = document.querySelectorAll('.calculator-grid button');
            const secondFnButton = document.getElementById('secondFnButton');
            const radDegButton = document.getElementById('radDegButton');
            const decimalModeButton = document.getElementById('decimalModeButton'); // New button
            const messageBoxOverlay = document.getElementById('messageBoxOverlay');
            const messageBoxText = document.getElementById('messageBoxText');
            const messageBoxOkButton = document.getElementById('messageBoxOkButton');

            let currentExpression = '';
            let memory = 0;
            let isSecondFunctionActive = false;
            let angleMode = 'Rad'; // Rad or Deg
            let justEvaluated = false; 
            
            const decimalModes = ['F', '0', '2', '4', '6', '8']; // F for Float, others for fixed
            let currentDecimalModeIndex = 0; // Index for decimalModes array
            let decimalPlaces = decimalModes[currentDecimalModeIndex]; // 'F' initially

            // --- Custom Message Box ---
            function showMessage(message) {
                messageBoxText.textContent = message;
                messageBoxOverlay.classList.add('visible');
            }
            messageBoxOkButton.addEventListener('click', () => {
                messageBoxOverlay.classList.remove('visible');
            });

            // --- Helper Functions ---
            function factorial(n) {
                if (n < 0) return NaN; 
                if (Number.isInteger(n) === false) return NaN; 
                if (n === 0 || n === 1) return 1;
                if (n > 170) return Infinity; 
                let result = 1;
                for (let i = 2; i <= n; i++) {
                    result *= i;
                }
                return result;
            }

            function toRadians(degrees) {
                return degrees * (Math.PI / 180);
            }

            function toDegrees(radians) {
                return radians * (180 / Math.PI);
            }
            
            function log2(n) {
                if (n <= 0) return NaN;
                return Math.log(n) / Math.log(2);
            }

            function nthRoot(value, n) {
                if (n === 0) return NaN; 
                if (value < 0 && n % 2 === 0) return NaN; 
                return Math.pow(value, 1 / n);
            }

            function formatResult(value) {
                const num = Number(value);
                if (isNaN(num)) return "Error";
                if (decimalPlaces === 'F') {
                    return String(num);
                } else {
                    return num.toFixed(parseInt(decimalPlaces));
                }
            }

            function updateDisplay() {
                if (justEvaluated && currentExpression !== '') {
                     // If it was just evaluated, currentExpression holds the raw result.
                     // Format it before displaying.
                    display.value = formatResult(currentExpression);
                } else {
                    display.value = currentExpression || '0';
                }
                display.scrollLeft = display.scrollWidth;
            }
            
            function appendToExpression(value) {
                if (justEvaluated && !isOperator(value) && value !== '(' && value !== ')' && value !== '.' && !value.startsWith('Math.') && !value.startsWith('√(') && !value.startsWith('∛(') && !value.startsWith('ln(') && !value.startsWith('log₁₀(') && !value.startsWith('log₂(') ) {
                    currentExpression = ''; 
                }
                justEvaluated = false;

                if (currentExpression === '0' && value !== '.' && !isOperator(value) && value !== '(') {
                    currentExpression = value;
                } else if (value === '.' && (currentExpression === '' || isOperator(currentExpression.slice(-1)) || currentExpression.slice(-1) === '(' )) {
                    currentExpression += '0.'; 
                } else if (value === '.' && currentExpression.split(/[\+\-\*\/\(\)\s]+/).pop().includes('.')) {
                    return; 
                }
                else {
                    currentExpression += value;
                }
                updateDisplay();
            }

            function isOperator(char) {
                return ['+', '-', '*', '/'].includes(char);
            }
            
            function getLastNumberSegment() {
                const match = currentExpression.match(/(-?(?:Math\.E|Math\.PI|\d*\.?\d+(?:e[+\-]?\d+)?))$/i);
                return match ? match[0] : null;
            }
            
            function getExpressionForEval(){
                 // Convert display-friendly trig/log functions to Math object calls for eval
                let expr = currentExpression
                    .replace(/π/g, 'Math.PI')
                    .replace(/(?<![a-zA-Z0-9_])e(?![+\-\d.a-zA-Z])/g, 'Math.E') // Target 'e' constant specifically
                    .replace(/√\(/g, 'Math.sqrt(')
                    .replace(/∛\(/g, 'Math.cbrt(')
                    .replace(/ln\(/g, 'Math.log(')
                    .replace(/log₁₀\(/g, 'Math.log10(')
                    .replace(/log₂\(/g, 'log2(');

                // Handle trig functions with angle mode
                const trigFuncs = {
                    'sin': 'Math.sin', 'cos': 'Math.cos', 'tan': 'Math.tan',
                    'asin': 'Math.asin', 'acos': 'Math.acos', 'atan': 'Math.atan'
                };
                for (const func in trigFuncs) {
                    const regex = new RegExp(`${func}\\(`, 'g'); // Matches "sin(", "cos(", etc.
                    expr = expr.replace(regex, `${trigFuncs[func]}(`);
                }
                
                // Factorial and power
                expr = expr.replace(/(\d*\.?\d+)!/g, (match, num) => `factorial(${num})`)
                           .replace(/\^/g, '**');
                return expr;
            }


            function handleOperation(buttonElement) { 
                let actionValue = buttonElement.dataset.value; 
                let visualLabel = buttonElement.innerHTML; 

                if (isSecondFunctionActive && buttonElement.dataset.secondValue) {
                    actionValue = buttonElement.dataset.secondValue;
                    visualLabel = buttonElement.dataset.secondLabelText || actionValue; 
                }

                if (justEvaluated && 
                    !['+', '-', '*', '/', '%', '**', '**(1/', ')', '=', 'DecimalMode'].includes(actionValue) && 
                    !actionValue.startsWith('Math.') && !actionValue.startsWith('√') && !actionValue.startsWith('∛') &&
                    !actionValue.startsWith('ln') && !actionValue.startsWith('log') 
                   ) {
                     if (!['(', 'sin', 'cos', 'tan', 'asin', 'acos', 'atan', 
                          'sinh', 'asinh', 'cosh', 'acosh', 'tanh', 'atanh',
                          'e^x', '10^x', 'x!', '1/x'].includes(actionValue)){
                        currentExpression = '';
                     }
                }
                // Do not set justEvaluated to false if it's a mode change like DecimalMode
                if (actionValue !== 'DecimalMode') {
                    justEvaluated = false;
                }


                switch (actionValue) {
                    case 'C':
                        currentExpression = '';
                        justEvaluated = false;
                        break;
                    case 'Backspace':
                        if (justEvaluated) { // If backspacing a result, clear it and start fresh
                            currentExpression = '';
                            justEvaluated = false;
                        } else if (currentExpression.endsWith('(') && currentExpression.length > 1) {
                            const funcPatterns = ['Math.sin(', 'Math.cos(', 'Math.tan(', 'Math.asin(', 'Math.acos(', 'Math.atan(', 'Math.sinh(', 'Math.cosh(', 'Math.tanh(', 'Math.asinh(', 'Math.acosh(', 'Math.atanh(', 'Math.sqrt(', 'Math.cbrt(', 'Math.log(', 'Math.log10(', 'log2(', 'factorial('];
                            let foundFunc = false;
                            for (const pattern of funcPatterns) {
                                if (currentExpression.endsWith(pattern)) {
                                    currentExpression = currentExpression.slice(0, -pattern.length);
                                    foundFunc = true;
                                    break;
                                }
                            }
                            if (!foundFunc) currentExpression = currentExpression.slice(0, -1);
                        } else if (currentExpression.endsWith('Math.PI')) {
                            currentExpression = currentExpression.slice(0, -7);
                        } else if (currentExpression.endsWith('Math.E')) {
                             currentExpression = currentExpression.slice(0, -6);
                        }
                        else {
                            currentExpression = currentExpression.slice(0, -1);
                        }
                        break;
                    case '(':
                    case ')':
                    case '.':
                        appendToExpression(actionValue);
                        break;
                    case '+':
                    case '-':
                    case '*':
                    case '/':
                        if (currentExpression === '' && actionValue !== '-') { 
                            break;
                        }
                        const lastChar = currentExpression.slice(-1);
                        if (isOperator(lastChar) || lastChar === '(') {
                            if (isOperator(lastChar) && actionValue !== '-' && currentExpression.length > 1 && !currentExpression.endsWith('(')) {
                                if(!isOperator(currentExpression.slice(-2, -1))){
                                     currentExpression = currentExpression.slice(0, -1) + actionValue; 
                                } else if (actionValue === '-'){ 
                                     appendToExpression(actionValue);
                                }
                            } else if (actionValue === '-' && (lastChar === '(' || isOperator(lastChar))) { 
                                appendToExpression(actionValue);
                            }
                        } else {
                           appendToExpression(actionValue);
                        }
                        break;
                    case '0': case '1': case '2': case '3': case '4': case '5': case '6': case '7': case '8': case '9':
                        appendToExpression(actionValue);
                        break;
                    case '=':
                        try {
                            let evalFriendlyExpression = getExpressionForEval();
                            
                            let openParenCount = (evalFriendlyExpression.match(/\(/g) || []).length;
                            let closeParenCount = (evalFriendlyExpression.match(/\)/g) || []).length;
                            while(openParenCount > closeParenCount){
                                evalFriendlyExpression += ')';
                                closeParenCount++;
                            }
                            
                            // Angle conversions for trig functions within eval
                            const trigFuncsForEval = ['Math.sin', 'Math.cos', 'Math.tan'];
                            trigFuncsForEval.forEach(funcName => {
                                const regex = new RegExp(funcName.replace('.', '\\.') + '\\(([^)]+)\\)', 'g');
                                evalFriendlyExpression = evalFriendlyExpression.replace(regex, (match, arg) => {
                                    if (angleMode === 'Deg') {
                                        return `${funcName}(toRadians(${arg}))`;
                                    }
                                    return `${funcName}(${arg})`; // Already in radians or doesn't need conversion
                                });
                            });

                            const inverseTrigFuncsForEval = ['Math.asin', 'Math.acos', 'Math.atan'];
                            inverseTrigFuncsForEval.forEach(funcName => {
                                 const regex = new RegExp(funcName.replace('.', '\\.') + '\\(([^)]+)\\)', 'g');
                                 evalFriendlyExpression = evalFriendlyExpression.replace(regex, (match, arg) => {
                                    if (angleMode === 'Deg') {
                                        return `toDegrees(${funcName}(${arg}))`;
                                    }
                                    return `${funcName}(${arg})`;
                                 });
                            });


                            const result = eval(evalFriendlyExpression);
                            if (isNaN(result) || !isFinite(result)) {
                                showMessage('Error: Result is undefined or infinite');
                                currentExpression = ''; 
                            } else {
                                currentExpression = String(result); // Store raw result
                                justEvaluated = true; // Display will format it
                            }
                        } catch (e) {
                            showMessage('Error: Invalid expression');
                            // console.error("Eval error:", e, "Original Expression:", currentExpression, "Eval'd:", getExpressionForEval());
                        }
                        break;
                    case 'mc': memory = 0; break;
                    case 'm+': 
                        try { memory += parseFloat(eval(getExpressionForEval() || '0')); } catch { showMessage("Error in M+ expr");}
                        break;
                    case 'm-': 
                        try { memory -= parseFloat(eval(getExpressionForEval() || '0')); } catch { showMessage("Error in M- expr");}
                        break;
                    case 'PI': appendToExpression('π'); break;
                    case 'E': appendToExpression('e'); break; 
                    case 'EE': appendToExpression('e'); break; 
                    // case 'Rand': currentExpression = String(Math.random()); justEvaluated = true; break; // Replaced by DecimalMode
                    case 'DecimalMode':
                        currentDecimalModeIndex = (currentDecimalModeIndex + 1) % decimalModes.length;
                        decimalPlaces = decimalModes[currentDecimalModeIndex];
                        decimalModeButton.textContent = decimalPlaces === 'F' ? 'F' : `.${decimalPlaces}`;
                        if (justEvaluated && currentExpression !== '') { // Re-format displayed result if mode changes
                            // No need to call updateDisplay() directly, it's called at the end of handleOperation
                        }
                        break;
                    case 'Rad': 
                        angleMode = angleMode === 'Rad' ? 'Deg' : 'Rad';
                        radDegButton.textContent = angleMode;
                        break;
                    case 'x^2': appendToExpression('**2'); break;
                    case 'x^3': appendToExpression('**3'); break;
                    case 'x^y': appendToExpression('**'); break; 
                    case 'e^x': 
                        currentExpression = `Math.exp(${getExpressionForEval() || '0'})`;
                        handleOperation({dataset:{value:'='}}); 
                        break;
                    case '10^x': 
                        currentExpression = `Math.pow(10, ${getExpressionForEval() || '0'})`;
                        handleOperation({dataset:{value:'='}}); 
                        break;
                    case '1/x': 
                        currentExpression = `(1/(${getExpressionForEval() || '0'}))`; 
                        handleOperation({dataset:{value:'='}}); 
                        break;
                    case 'sqrt': appendToExpression('√('); break;
                    case 'cbrt': appendToExpression('∛('); break;
                    case 'y_sqrt_x': appendToExpression('**(1/'); break; 
                    case 'ln': appendToExpression('ln('); break;
                    case 'log10': appendToExpression('log₁₀('); break;
                    case 'log2': appendToExpression('log₂('); break; 
                    case 'x!': 
                        const numForFactorial = getLastNumberSegment();
                        if (numForFactorial) {
                             currentExpression = currentExpression.slice(0, -numForFactorial.length) + `${numForFactorial}!`;
                        } else {
                             currentExpression += '!'; 
                        }
                        break; 
                    
                    case 'sin': case 'asin':
                    case 'cos': case 'acos':
                    case 'tan': case 'atan':
                    case 'sinh': case 'asinh':
                    case 'cosh': case 'acosh':
                    case 'tanh': case 'atanh':
                        // Use the visual label (sin, cos) for appending, eval will handle Math. prefix
                        appendToExpression(`${visualLabel}(`);
                        break;
                    
                    case '%':
                        const lastNumStrPerc = getLastNumberSegment();
                        if (lastNumStrPerc) {
                            const num = parseFloat(lastNumStrPerc);
                            const exprBeforeLastNum = currentExpression.slice(0, -lastNumStrPerc.length);
                            const matchPrevOpNum = exprBeforeLastNum.match(/(-?(?:Math\.E|Math\.PI|\d*\.?\d+(?:e[+\-]?\d+)?))([\+\-\*\/])$/i); // Added Math.E/PI
                            if(matchPrevOpNum){
                                const prevNumRaw = matchPrevOpNum[1].replace('Math.PI', Math.PI).replace('Math.E', Math.E);
                                const prevNum = parseFloat(prevNumRaw);
                                const operator = matchPrevOpNum[2];
                                const percentageVal = prevNum * (num / 100);
                                currentExpression = exprBeforeLastNum.slice(0, exprBeforeLastNum.length - matchPrevOpNum[0].length) + String(prevNum) + operator + String(percentageVal);

                            } else { 
                                currentExpression = currentExpression.substring(0, currentExpression.length - lastNumStrPerc.length) + String(num / 100);
                            }
                        } else { 
                            try {
                                const evalResult = eval(getExpressionForEval() || '0');
                                currentExpression = String(evalResult / 100);
                            } catch {
                                showMessage("Error in % calculation");
                            }
                        }
                        justEvaluated = true; 
                        break;
                    case 'ToggleSign':
                        const lastNumSign = getLastNumberSegment();
                        if (lastNumSign) {
                            const numSegment = currentExpression.slice(-lastNumSign.length);
                            if (numSegment.startsWith('(-') && numSegment.endsWith(')')) { 
                                currentExpression = currentExpression.slice(0, -lastNumSign.length) + numSegment.substring(2, numSegment.length - 1);
                            } else if (numSegment.startsWith('-')) { 
                                currentExpression = currentExpression.slice(0, -lastNumSign.length) + numSegment.substring(1);
                            } else { 
                                currentExpression = currentExpression.slice(0, -lastNumSign.length) + `(-${numSegment})`;
                            }
                        } else if (currentExpression && currentExpression !== '0') {
                           if (currentExpression.startsWith('(-') && currentExpression.endsWith(')')) {
                                currentExpression = currentExpression.substring(2, currentExpression.length - 1);
                           } else if (currentExpression.startsWith('-')) {
                                currentExpression = currentExpression.substring(1);
                           } else {
                                currentExpression = `(-${currentExpression})`;
                           }
                        }
                        break;
                    case '2nd': 
                        break;

                }
                updateDisplay();
            }
            
            buttons.forEach(button => {
                const value = button.dataset.value;
                const secondValue = button.dataset.secondValue;
                let primaryHTML = button.innerHTML; 
                
                button.dataset.primaryLabel = primaryHTML; 

                if (secondValue) {
                    let secondLabelHTML = secondValue; 
                    if (value === "x^2" && secondValue === "x^3") secondLabelHTML = "x³";
                    else if (value === "x^3" && secondValue === "x^y") secondLabelHTML = "xʸ";
                    else if (value === "x^y" && secondValue === "y_sqrt_x") secondLabelHTML = "ʸ√x";
                    else if (value === "e^x" && secondValue === "10^x") secondLabelHTML = "10ˣ";
                    else if (value === "10^x" && secondValue === "1/x") secondLabelHTML = "¹/x";
                    else if (value === "1/x" && secondValue === "sqrt") secondLabelHTML = "√x";
                    else if (value === "sqrt" && secondValue === "cbrt") secondLabelHTML = "∛x";
                    else if (value === "cbrt" && secondValue === "y_sqrt_x") secondLabelHTML = "ʸ√x"; 
                    else if (value === "ln" && secondValue === "log10") secondLabelHTML = "log₁₀";
                    else if (value === "log10" && secondValue === "log2") secondLabelHTML = "log₂";
                    else if (value === "sin" && secondValue === "asin") secondLabelHTML = "sin<sup>-1</sup>";
                    else if (value === "cos" && secondValue === "acos") secondLabelHTML = "cos<sup>-1</sup>";
                    else if (value === "tan" && secondValue === "atan") secondLabelHTML = "tan<sup>-1</sup>";
                    else if (value === "sinh" && secondValue === "asinh") secondLabelHTML = "sinh<sup>-1</sup>";
                    else if (value === "cosh" && secondValue === "acosh") secondLabelHTML = "cosh<sup>-1</sup>";
                    else if (value === "tanh" && secondValue === "atanh") secondLabelHTML = "tanh<sup>-1</sup>";
                    button.dataset.secondLabelText = secondLabelHTML; 
                }
                // Special handling for the decimal mode button to avoid its click being processed by the generic handler if not needed
                if (button.id !== 'decimalModeButton' && button.id !== 'secondFnButton' && button.id !== 'radDegButton') {
                     button.addEventListener('click', () => handleOperation(button));
                }
            });
            
            if (secondFnButton) { 
                secondFnButton.addEventListener('click', () => { // Changed from handleOperation to direct logic
                    isSecondFunctionActive = !isSecondFunctionActive;
                    secondFnButton.classList.toggle('bg-sky-500', isSecondFunctionActive); 
                    secondFnButton.classList.toggle('text-white', isSecondFunctionActive);
                    secondFnButton.classList.toggle('bg-slate-700', !isSecondFunctionActive);
                    secondFnButton.classList.toggle('text-slate-300', !isSecondFunctionActive);

                    buttons.forEach(btn => {
                        if (btn.id === 'secondFnButton') return; 
                        const primaryLabel = btn.dataset.primaryLabel; 
                        const secondLabel = btn.dataset.secondLabelText; 
                        if (isSecondFunctionActive && secondLabel) {
                            btn.innerHTML = secondLabel;
                        } else if (primaryLabel) {
                            btn.innerHTML = primaryLabel;
                        }
                    });
                });
            }

            if (radDegButton) {
                radDegButton.addEventListener('click', () => handleOperation(radDegButton));
            }
            if (decimalModeButton) {
                decimalModeButton.addEventListener('click', () => handleOperation(decimalModeButton));
            }

            updateDisplay(); 
        });
    </script>
</body>
</html>
