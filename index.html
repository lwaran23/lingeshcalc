<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Scientific Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; 
        }

        .calculator-grid button {
            transition: background-color 0.15s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.15s ease-in-out, filter 0.1s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            will-change: transform, box-shadow, filter; 
        }
        .calculator-grid button:hover {
            transform: translateY(-2px); 
            box-shadow: 0 5px 10px rgba(0,0,0,0.25); 
            filter: brightness(1.15); 
        }
        .calculator-grid button:active {
            transform: scale(0.95) translateY(1px); 
            box-shadow: 0 1px 2px rgba(0,0,0,0.2); 
            filter: brightness(0.85); 
        }

        .display-area {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); 
        }
        .display-area::-webkit-scrollbar {
            height: 4px;
        }
        .display-area::-webkit-scrollbar-thumb {
            background-color: #475569; /* slate-600 */
            border-radius: 2px;
        }
        .display-area::-webkit-scrollbar-track {
            background-color: #1e293b; /* slate-800 */
        }
        #display-text.display-text-animate { 
            animation: subtlePop 0.2s ease-out;
        }

        @keyframes subtlePop {
            0% { transform: scale(0.98) translateY(1px); opacity: 0.8; }
            70% { transform: scale(1.01); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .calculator-grid button sup {
            font-size: 0.6em;
            top: -0.6em; 
            position: relative;
            display: inline-block;
            line-height: 1; 
        }
        .hidden { /* Tailwind's hidden class */
            display: none !important;
        }
    </style>
</head>
<body class="bg-slate-900 flex items-center justify-center min-h-screen p-4">
    <div class="calculator-container bg-slate-800 shadow-2xl rounded-xl p-6 w-full max-w-sm">
        <div id="display-container" class="display-area bg-slate-950 text-white text-5xl font-light text-right p-6 mb-6 rounded-lg break-all h-24 flex items-end justify-end overflow-x-auto">
            <span id="display-text">0</span>
        </div>

        <div class="calculator-grid grid grid-cols-4 gap-3">
            <button data-action="toggle-calculator-mode" id="modeToggleButton" class="col-span-4 bg-indigo-600 hover:bg-indigo-700 text-white text-lg font-medium py-3 rounded-lg mb-2">Scientific Mode</button>

            <button data-action="toggle-angle-mode" class="scientific-feature btn-sci bg-slate-600 text-white text-lg font-medium py-4 rounded-lg">DEG</button>
            <button data-sci-op="sin" class="scientific-feature btn-sci bg-slate-600 text-white text-xl font-medium py-4 rounded-lg">sin</button>
            <button data-sci-op="cos" class="scientific-feature btn-sci bg-slate-600 text-white text-xl font-medium py-4 rounded-lg">cos</button>
            <button data-sci-op="tan" class="scientific-feature btn-sci bg-slate-600 text-white text-xl font-medium py-4 rounded-lg">tan</button>

            <button data-operator="power" class="scientific-feature btn-sci bg-slate-600 text-white text-xl font-medium py-4 rounded-lg">x<sup>y</sup></button>
            <button data-sci-op="log" class="scientific-feature btn-sci bg-slate-600 text-white text-xl font-medium py-4 rounded-lg">log</button>
            <button data-sci-op="ln" class="scientific-feature btn-sci bg-slate-600 text-white text-xl font-medium py-4 rounded-lg">ln</button>
            <button data-sci-op="sqrt" class="scientific-feature btn-sci bg-slate-600 text-white text-xl font-medium py-4 rounded-lg">√</button>
            
            <button data-sci-op="square" class="scientific-feature btn-sci bg-slate-600 text-white text-xl font-medium py-4 rounded-lg">x<sup>2</sup></button>
            <button data-sci-op="reciprocal" class="scientific-feature btn-sci bg-slate-600 text-white text-xl font-medium py-4 rounded-lg">1/x</button>
            <button data-constant="pi" class="scientific-feature btn-sci bg-slate-600 text-white text-xl font-medium py-4 rounded-lg">π</button>
            <button data-constant="e" class="scientific-feature btn-sci bg-slate-600 text-white text-xl font-medium py-4 rounded-lg">e</button>

            <button data-action="clear" class="btn-special bg-rose-600 text-white text-xl font-medium py-4 rounded-lg">AC</button>
            <button data-action="delete" class="btn-special bg-amber-500 text-white text-xl font-medium py-4 rounded-lg">DEL</button>
            <button data-action="toggle-sign" class="btn-special bg-slate-500 text-white text-xl font-medium py-4 rounded-lg">+/-</button>
            <button data-action="percentage" class="btn-special bg-slate-500 text-white text-xl font-medium py-4 rounded-lg">%</button>
            
            <button data-number="7" class="btn-number bg-slate-700 text-white text-2xl font-medium py-5 rounded-lg">7</button>
            <button data-number="8" class="btn-number bg-slate-700 text-white text-2xl font-medium py-5 rounded-lg">8</button>
            <button data-number="9" class="btn-number bg-slate-700 text-white text-2xl font-medium py-5 rounded-lg">9</button>
            <button data-operator="divide" class="btn-operator bg-sky-500 text-white text-2xl font-medium py-5 rounded-lg">/</button>

            <button data-number="4" class="btn-number bg-slate-700 text-white text-2xl font-medium py-5 rounded-lg">4</button>
            <button data-number="5" class="btn-number bg-slate-700 text-white text-2xl font-medium py-5 rounded-lg">5</button>
            <button data-number="6" class="btn-number bg-slate-700 text-white text-2xl font-medium py-5 rounded-lg">6</button>
            <button data-operator="multiply" class="btn-operator bg-sky-500 text-white text-2xl font-medium py-5 rounded-lg">*</button>

            <button data-number="1" class="btn-number bg-slate-700 text-white text-2xl font-medium py-5 rounded-lg">1</button>
            <button data-number="2" class="btn-number bg-slate-700 text-white text-2xl font-medium py-5 rounded-lg">2</button>
            <button data-number="3" class="btn-number bg-slate-700 text-white text-2xl font-medium py-5 rounded-lg">3</button>
            <button data-operator="subtract" class="btn-operator bg-sky-500 text-white text-2xl font-medium py-5 rounded-lg">-</button>

            <button data-number="0" class="btn-number col-span-2 bg-slate-700 text-white text-2xl font-medium py-5 rounded-lg">0</button>
            <button data-action="decimal" class="btn-number bg-slate-700 text-white text-2xl font-medium py-5 rounded-lg">.</button>
            <button data-operator="add" class="btn-operator bg-sky-500 text-white text-2xl font-medium py-5 rounded-lg">+</button>
            <button data-action="calculate" class="btn-equal bg-emerald-500 text-white text-2xl font-medium py-5 rounded-lg">=</button>
        </div>
    </div>

    <script>
        const displaySpan = document.getElementById('display-text');
        const buttons = document.querySelector('.calculator-grid');
        const angleModeButton = document.querySelector('[data-action="toggle-angle-mode"]'); // This is a scientific feature
        const modeToggleButton = document.getElementById('modeToggleButton');
        const scientificButtons = document.querySelectorAll('.scientific-feature');

        let currentValue = '0';
        let previousValue = '';
        let operator = null;
        let waitingForSecondOperand = false;
        let justCalculated = false;
        let angleMode = 'deg'; // 'deg' or 'rad'
        let calculatorMode = 'normal'; // 'normal' or 'scientific'

        // Function to update visibility of scientific buttons based on mode
        function updateButtonVisibility() {
            if (calculatorMode === 'normal') {
                scientificButtons.forEach(btn => btn.classList.add('hidden'));
                modeToggleButton.textContent = 'Scientific Mode'; // Text indicates what it will switch TO
            } else { // scientific mode
                scientificButtons.forEach(btn => btn.classList.remove('hidden'));
                modeToggleButton.textContent = 'Normal Mode'; // Text indicates what it will switch TO
            }
            // Ensure the angleModeButton's text is correct if it becomes visible
            if (angleModeButton && !angleModeButton.classList.contains('hidden')) {
                 angleModeButton.textContent = angleMode.toUpperCase();
            }
        }

        // Function to toggle calculator mode
        function toggleCalculatorMode() {
            calculatorMode = calculatorMode === 'normal' ? 'scientific' : 'normal';
            updateButtonVisibility();
            // Optional: Reset calculator state when switching modes? For now, no.
            // clearAll(); 
        }
        
        // Function to update the display
        function updateDisplay() {
            let formattedValue = currentValue;
            const maxLength = 15; 
            if (currentValue === 'Error') {
                formattedValue = 'Error';
            } else if (formattedValue.length > maxLength) {
                const num = parseFloat(formattedValue);
                if (Math.abs(num) > 1e14 || (Math.abs(num) < 1e-6 && num !== 0)) {
                     formattedValue = num.toExponential(6);
                } else if (String(num).length > maxLength) { 
                    if (formattedValue.includes('.')) {
                        const parts = formattedValue.split('.');
                        const decimalPartLength = parts[1].length;
                        if (decimalPartLength > 8) { 
                           formattedValue = num.toFixed(8);
                           if(formattedValue.length > maxLength) { 
                               formattedValue = formattedValue.substring(0, maxLength) + "...";
                           }
                        } else {
                             formattedValue = formattedValue.substring(0, maxLength) + "...";
                        }
                    } else {
                        formattedValue = formattedValue.substring(0, maxLength) + "...";
                    }
                }
            }
            displaySpan.textContent = formattedValue;
            displaySpan.classList.add('display-text-animate');
            setTimeout(() => {
                displaySpan.classList.remove('display-text-animate');
            }, 200);
        }

        // Function to handle number input
        function inputNumber(number) {
            if (currentValue === 'Error') {
                currentValue = number;
            } else if (justCalculated) {
                currentValue = number;
                justCalculated = false;
            } else if (waitingForSecondOperand) {
                currentValue = number;
                waitingForSecondOperand = false;
            } else {
                currentValue = currentValue === '0' ? number : currentValue + number;
            }
            if (currentValue.length > 20) { 
                currentValue = currentValue.substring(0, 20);
            }
            updateDisplay();
        }

        // Function to handle decimal input
        function inputDecimal() {
            if (currentValue === 'Error') {
                currentValue = '0.';
            } else if (justCalculated) {
                currentValue = '0.';
                justCalculated = false;
                waitingForSecondOperand = false;
            } else if (waitingForSecondOperand) {
                currentValue = '0.';
                waitingForSecondOperand = false;
            } else if (!currentValue.includes('.')) {
                currentValue += '.';
            }
            updateDisplay();
        }
        
        // Function to handle binary operator input (+, -, *, /, x^y)
        function handleOperator(nextOperator) {
            if (currentValue === 'Error' && nextOperator) return; 

            // If it's a scientific operator (like power) but we are in normal mode, do nothing.
            if (calculatorMode === 'normal' && nextOperator === 'power') return;


            const inputValue = parseFloat(currentValue);
            if (operator && !waitingForSecondOperand && !justCalculated) {
                const result = performCalculation();
                currentValue = String(result);
                previousValue = String(result); 
            } else if (justCalculated) {
                previousValue = currentValue; 
            } else {
                previousValue = currentValue;
            }
            
            waitingForSecondOperand = true;
            operator = nextOperator;
            justCalculated = false;
        }

        // Function to handle unary scientific operations
        function handleUnaryOperation(operation) {
            if (calculatorMode === 'normal' || currentValue === 'Error') return; // Only if in scientific mode
            let value = parseFloat(currentValue);
            let result;

            const toRadians = (angle) => angleMode === 'deg' ? (angle * Math.PI / 180) : angle;
            // const fromRadians = (angle) => angleMode === 'deg' ? (angle * 180 / Math.PI) : angle; // Not used for results here

            switch (operation) {
                case 'sin': result = Math.sin(toRadians(value)); break;
                case 'cos': result = Math.cos(toRadians(value)); break;
                case 'tan':
                    if (Math.abs(Math.cos(toRadians(value))) < 1e-12) { 
                        currentValue = 'Error'; updateDisplay(); return;
                    }
                    result = Math.tan(toRadians(value));
                    break;
                case 'log': 
                    if (value <= 0) { currentValue = 'Error'; updateDisplay(); return; }
                    result = Math.log10(value);
                    break;
                case 'ln': 
                    if (value <= 0) { currentValue = 'Error'; updateDisplay(); return; }
                    result = Math.log(value);
                    break;
                case 'sqrt':
                    if (value < 0) { currentValue = 'Error'; updateDisplay(); return; }
                    result = Math.sqrt(value);
                    break;
                case 'square': 
                    result = Math.pow(value, 2);
                    break;
                case 'reciprocal': 
                    if (value === 0) { currentValue = 'Error'; updateDisplay(); return; }
                    result = 1 / value;
                    break;
                default: return; 
            }

            if (Math.abs(result) < 1e-12) result = 0;
            
            currentValue = String(result);
            justCalculated = true;
            waitingForSecondOperand = false; 
            updateDisplay();
        }

        // Function to handle constants
        function handleConstant(constantKey) {
            if (calculatorMode === 'normal') return; // Only if in scientific mode
            switch (constantKey) {
                case 'pi': currentValue = String(Math.PI); break;
                case 'e': currentValue = String(Math.E); break;
            }
            justCalculated = false; 
            waitingForSecondOperand = false;
            updateDisplay();
        }
        
        // Function to perform calculation
        function performCalculation() {
            const prev = parseFloat(previousValue);
            const current = parseFloat(currentValue);
            let result = 0;

            if (isNaN(prev) || isNaN(current)) {
                return currentValue;
            }

            switch (operator) {
                case 'add': result = prev + current; break;
                case 'subtract': result = prev - current; break;
                case 'multiply': result = prev * current; break;
                case 'divide':
                    if (current === 0) return 'Error';
                    result = prev / current;
                    break;
                case 'power': 
                    if (calculatorMode === 'normal') return current; // Power is scientific
                    result = Math.pow(prev, current);
                    break;
                default: return currentValue; 
            }
            
            if (String(result).includes('.') && String(result).split('.')[1].length > 10) {
                result = parseFloat(result.toFixed(10)); 
            }
            if (Math.abs(result) < 1e-12) result = 0;

            return String(result);
        }

        // Function to clear all
        function clearAll() {
            currentValue = '0';
            previousValue = '';
            operator = null;
            waitingForSecondOperand = false;
            justCalculated = false;
            updateDisplay();
        }
        
        // Function to delete last digit (Backspace)
        function deleteLastDigit() {
            if (currentValue === 'Error') {
                currentValue = '0';
            } else if (justCalculated) {
                currentValue = '0';
                justCalculated = false;
            } else if (currentValue.length > 1) {
                currentValue = currentValue.slice(0, -1);
            } else {
                currentValue = '0';
            }
            updateDisplay();
        }

        // Function to toggle sign
        function toggleSign() {
            if (currentValue === '0' || currentValue === 'Error') return;
            currentValue = String(parseFloat(currentValue) * -1);
            if (justCalculated) { 
                previousValue = currentValue; 
            }
            updateDisplay();
        }

        // Function to handle percentage
        function handlePercentage() {
            if (currentValue === 'Error') return;
            let numericValue = parseFloat(currentValue);
            if (operator && previousValue !== '') {
                const prev = parseFloat(previousValue);
                numericValue = (prev * numericValue) / 100;
            } else {
                numericValue = numericValue / 100;
            }
            currentValue = String(numericValue);
            justCalculated = true; 
            updateDisplay();
        }

        // Function to toggle angle mode (degrees/radians)
        function toggleAngleMode() {
            if (calculatorMode === 'normal') return; // Only if in scientific mode
            angleMode = angleMode === 'deg' ? 'rad' : 'deg';
            if (angleModeButton) angleModeButton.textContent = angleMode.toUpperCase();
        }

        // Event listener for button clicks
        buttons.addEventListener('click', (event) => {
            const { target } = event;
            const buttonElement = target.closest('button');
            if (!buttonElement) return;

            // If a hidden button is somehow clicked (e.g. through rapidly changing mode), ignore
            if (buttonElement.classList.contains('hidden')) return;

            const { action, number, operator: opKey, sciOp, constantKey } = buttonElement.dataset;

            if (action === 'toggle-calculator-mode') {
                toggleCalculatorMode();
            } else if (number) {
                inputNumber(number);
            } else if (action === 'decimal') {
                inputDecimal();
            } else if (opKey) {
                handleOperator(opKey);
            } else if (sciOp && calculatorMode === 'scientific') { // Ensure scientific mode for sci-op
                handleUnaryOperation(sciOp);
            } else if (constantKey && calculatorMode === 'scientific') { // Ensure scientific mode for constants
                handleConstant(constantKey);
            } else if (action === 'calculate') {
                if (operator && previousValue !== '' && !waitingForSecondOperand && currentValue !== 'Error') {
                    currentValue = performCalculation();
                    operator = null; 
                    previousValue = ''; 
                    justCalculated = true; 
                    waitingForSecondOperand = false;
                }
                updateDisplay();
            } else if (action === 'clear') {
                clearAll();
            } else if (action === 'delete') {
                deleteLastDigit();
            } else if (action === 'toggle-sign') {
                toggleSign();
            } else if (action === 'percentage') {
                handlePercentage();
            } else if (action === 'toggle-angle-mode' && calculatorMode === 'scientific') { // Ensure scientific mode
                toggleAngleMode();
            }
        });
        
        // Initialize display and button visibility
        updateDisplay();
        updateButtonVisibility(); // Set initial visibility based on default calculatorMode

        // Keyboard support
        document.addEventListener('keydown', (event) => {
            let { key } = event;
            
            if (key >= '0' && key <= '9') {
                inputNumber(key);
            } else if (key === '.') {
                inputDecimal();
            } else if (key === '+' || key === '-' || key === '*' || key === '/') {
                event.preventDefault(); 
                const opMap = { '+': 'add', '-': 'subtract', '*': 'multiply', '/': 'divide' };
                handleOperator(opMap[key]);
            } else if (key === 'Enter' || key === '=') {
                event.preventDefault();
                const equalsButton = document.querySelector('[data-action="calculate"]');
                if (equalsButton) equalsButton.click();
            } else if (key === 'Backspace') {
                event.preventDefault();
                deleteLastDigit();
            } else if (key.toLowerCase() === 'c' || key === 'Escape') {
                 event.preventDefault();
                 clearAll();
            } else if (key === '%') {
                event.preventDefault();
                handlePercentage();
            } 
            // Scientific keys only if in scientific mode
            else if (calculatorMode === 'scientific') {
                if (key.toLowerCase() === 'p') { 
                    event.preventDefault(); handleConstant('pi');
                } else if (key.toLowerCase() === 'e') { 
                    event.preventDefault(); handleConstant('e');
                } else if (key.toLowerCase() === 's') { 
                    event.preventDefault(); handleUnaryOperation('sin');
                } else if (key.toLowerCase() === 't') { 
                    event.preventDefault(); handleUnaryOperation('tan');
                } // Add more: 'c' for cos, 'l' for log, 'r' for sqrt, etc.
                  // Be careful with 'c' as it's also for Clear.
            }
        });
    </script>
</body>
</html>
